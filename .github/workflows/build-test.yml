name: Build Test - OpenSSL and curl

on:
  push:
    branches: [ main, master ]
    paths:
      - 'contrib/src/openssl/**'
      - 'contrib/src/curl/**'
      - 'contrib/src/zlib/**'
      - '.github/workflows/build-test.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'contrib/src/openssl/**'
      - 'contrib/src/curl/**'
      - 'contrib/src/zlib/**'
      - '.github/workflows/build-test.yml'
  workflow_dispatch:

jobs:
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    strategy:
      matrix:
        lib: [openssl, curl]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install autoconf automake cmake libtool

      - name: Setup build environment
        run: |
          cd build
          chmod +x build.sh

      - name: Build ${{ matrix.lib }} on macOS
        run: |
          cd build
          # Set library archive alias mapping
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          echo "Building ${{ matrix.lib }} (archive name: $ARCHIVE_NAME)"
          ./build.sh -p=mac --libs=${{ matrix.lib }} --arch=x86_64 --mode=release 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
            echo "Last 50 lines of build log:"
            tail -50 build.log || true
            exit $BUILD_EXIT_CODE
          fi

      - name: Check build artifacts
        run: |
          # Determine archive name based on library
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          
          # Check for build output directory
          OUTPUT_DIR="build/mac/$ARCHIVE_NAME/prebuilt"
          echo "Checking for output directory: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "✅ Build successful: ${{ matrix.lib }}"
            echo "Output directory contents:"
            find "$OUTPUT_DIR" -type f -name "*.a" | head -20
            ls -la "$OUTPUT_DIR" || true
          else
            echo "❌ Build failed: ${{ matrix.lib }} - no artifacts found at $OUTPUT_DIR"
            echo "Checking alternative locations..."
            find build -name "*${{ matrix.lib }}*" -type d 2>/dev/null | head -10 || true
            find build -name "*$ARCHIVE_NAME*" -type d 2>/dev/null | head -10 || true
            echo "Build directory structure:"
            ls -la build/ || true
            if [ -d "build/mac" ]; then
              ls -la build/mac/ || true
            fi
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.lib }}-macos-x86_64
          path: |
            build/mac/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/prebuilt/
            build/mac/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/include/
          retention-days: 7

  build-ios:
    name: Build on iOS
    runs-on: macos-latest
    strategy:
      matrix:
        lib: [openssl, curl]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install autoconf automake cmake libtool

      - name: Setup build environment
        run: |
          cd build
          chmod +x build.sh

      - name: Build ${{ matrix.lib }} on iOS
        run: |
          cd build
          # Set library archive alias mapping
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          echo "Building ${{ matrix.lib }} (archive name: $ARCHIVE_NAME) for iOS"
          # Build for all iOS architectures: armv7, arm64, i386, x86_64
          ./build.sh -p=ios --libs=${{ matrix.lib }} --arch=armv7,arm64,i386,x86_64 --mode=release 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
            echo "Last 50 lines of build log:"
            tail -50 build.log || true
            exit $BUILD_EXIT_CODE
          fi

      - name: Check build artifacts
        run: |
          # Determine archive name based on library
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          
          # Check for build output directory
          OUTPUT_DIR="build/ios/$ARCHIVE_NAME/prebuilt"
          echo "Checking for output directory: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "✅ Build successful: ${{ matrix.lib }}"
            echo "Output directory contents:"
            find "$OUTPUT_DIR" -type f -name "*.a" | head -20
            ls -la "$OUTPUT_DIR" || true
            # Verify fat library (iOS creates fat libraries)
            if [ -f "$OUTPUT_DIR/lib${ARCHIVE_NAME}.a" ]; then
              echo "✅ Found fat library: lib${ARCHIVE_NAME}.a"
              # Check architectures in fat library
              lipo -info "$OUTPUT_DIR/lib${ARCHIVE_NAME}.a" || true
            fi
          else
            echo "❌ Build failed: ${{ matrix.lib }} - no artifacts found at $OUTPUT_DIR"
            echo "Checking alternative locations..."
            find build -name "*${{ matrix.lib }}*" -type d 2>/dev/null | head -10 || true
            find build -name "*$ARCHIVE_NAME*" -type d 2>/dev/null | head -10 || true
            echo "Build directory structure:"
            ls -la build/ || true
            if [ -d "build/ios" ]; then
              ls -la build/ios/ || true
            fi
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.lib }}-ios-universal
          path: |
            build/ios/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/prebuilt/
            build/ios/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/include/
          retention-days: 7

  build-android:
    name: Build on Android
    runs-on: macos-latest
    strategy:
      matrix:
        lib: [openssl, curl]
        arch: [armv7, arm64, x86]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install autoconf automake cmake libtool

      - name: Download and setup Android NDK
        run: |
          # Download Android NDK r25c
          NDK_VERSION="r25c"
          NDK_ZIP="android-ndk-${NDK_VERSION}-darwin.zip"
          NDK_URL="https://dl.google.com/android/repository/${NDK_ZIP}"
          
          echo "Downloading Android NDK ${NDK_VERSION}..."
          curl -L -o "${NDK_ZIP}" "${NDK_URL}"
          
          echo "Extracting Android NDK..."
          unzip -q "${NDK_ZIP}"
          
          # Set ANDROID_NDK environment variable
          NDK_PATH="$(pwd)/android-ndk-${NDK_VERSION}"
          echo "ANDROID_NDK=${NDK_PATH}" >> $GITHUB_ENV
          echo "ANDROID_NDK=${NDK_PATH}" >> $GITHUB_PATH
          
          echo "Android NDK installed at: ${NDK_PATH}"
          ls -la "${NDK_PATH}" | head -10

      - name: Setup build environment
        run: |
          cd build
          chmod +x build.sh
          echo "ANDROID_NDK=${ANDROID_NDK}"

      - name: Build ${{ matrix.lib }} on Android (${{ matrix.arch }})
        run: |
          cd build
          # Set library archive alias mapping
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          echo "Building ${{ matrix.lib }} (archive name: $ARCHIVE_NAME) for Android ${{ matrix.arch }}"
          # Build for specific Android architecture
          ./build.sh -p=android --libs=${{ matrix.lib }} --arch=${{ matrix.arch }} --mode=release 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
            echo "Last 50 lines of build log:"
            tail -50 build.log || true
            exit $BUILD_EXIT_CODE
          fi

      - name: Check build artifacts
        run: |
          # Determine archive name based on library
          if [ "${{ matrix.lib }}" == "openssl" ]; then
            ARCHIVE_NAME="ssl"
          elif [ "${{ matrix.lib }}" == "curl" ]; then
            ARCHIVE_NAME="curl"
          else
            ARCHIVE_NAME="${{ matrix.lib }}"
          fi
          
          # Android uses architecture-specific folder names
          case "${{ matrix.arch }}" in
            armv7)
              ANDROID_ARCH_FOLDER="armeabi-v7a"
              ;;
            arm64)
              ANDROID_ARCH_FOLDER="arm64-v8a"
              ;;
            x86)
              ANDROID_ARCH_FOLDER="x86"
              ;;
            *)
              ANDROID_ARCH_FOLDER="${{ matrix.arch }}"
              ;;
          esac
          
          # Check for build output directory
          OUTPUT_DIR="build/android/$ARCHIVE_NAME/prebuilt/$ANDROID_ARCH_FOLDER"
          echo "Checking for output directory: $OUTPUT_DIR"
          
          if [ -d "$OUTPUT_DIR" ]; then
            echo "✅ Build successful: ${{ matrix.lib }} for ${{ matrix.arch }}"
            echo "Output directory contents:"
            find "$OUTPUT_DIR" -type f -name "*.a" | head -20
            ls -la "$OUTPUT_DIR" || true
          else
            echo "❌ Build failed: ${{ matrix.lib }} - no artifacts found at $OUTPUT_DIR"
            echo "Checking alternative locations..."
            find build -name "*${{ matrix.lib }}*" -type d 2>/dev/null | head -10 || true
            find build -name "*$ARCHIVE_NAME*" -type d 2>/dev/null | head -10 || true
            echo "Build directory structure:"
            ls -la build/ || true
            if [ -d "build/android" ]; then
              ls -la build/android/ || true
            fi
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.lib }}-android-${{ matrix.arch }}
          path: |
            build/android/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/prebuilt/
            build/android/${{ matrix.lib == 'openssl' && 'ssl' || matrix.lib }}/include/
          retention-days: 7

  verify-versions:
    name: Verify Library Versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify OpenSSL version
        run: |
          OPENSSL_VERSION=$(grep "OPENSSL_VERSION :=" contrib/src/openssl/rules.mak | cut -d' ' -f3)
          echo "OpenSSL version in rules.mak: $OPENSSL_VERSION"
          if [ "$OPENSSL_VERSION" != "1.1.1w" ]; then
            echo "❌ Expected OpenSSL 1.1.1w, found $OPENSSL_VERSION"
            exit 1
          fi
          echo "✅ OpenSSL version correct: $OPENSSL_VERSION"

      - name: Verify curl version
        run: |
          CURL_VERSION=$(grep "CURL_VERSION :=" contrib/src/curl/rules.mak | cut -d' ' -f3)
          echo "curl version in rules.mak: $CURL_VERSION"
          if [ "$CURL_VERSION" != "7.88.1" ]; then
            echo "❌ Expected curl 7.88.1, found $CURL_VERSION"
            exit 1
          fi
          echo "✅ curl version correct: $CURL_VERSION"

      - name: Verify SHA512SUMS format
        run: |
          echo "Checking OpenSSL SHA512SUMS..."
          if [ -f "contrib/src/openssl/SHA512SUMS" ]; then
            if grep -q "openssl-1.1.1w.tar.gz" contrib/src/openssl/SHA512SUMS; then
              echo "✅ OpenSSL SHA512SUMS contains correct filename"
            else
              echo "❌ OpenSSL SHA512SUMS missing or incorrect"
              exit 1
            fi
          fi
          
          echo "Checking curl SHA512SUMS..."
          if [ -f "contrib/src/curl/SHA512SUMS" ]; then
            if grep -q "curl-7.88.1.tar.gz" contrib/src/curl/SHA512SUMS; then
              echo "✅ curl SHA512SUMS contains correct filename"
            else
              echo "❌ curl SHA512SUMS missing or incorrect"
              exit 1
            fi
          fi

  build-windows:
    name: Build on Windows (Win32)
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, Win32]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Strawberry Perl
        run: |
          # Download and install Strawberry Perl
          $perlUrl = "https://strawberryperl.com/download/5.32.1.1/strawberry-perl-5.32.1.1-64bit.msi"
          $perlInstaller = "$env:TEMP\strawberry-perl.msi"
          Invoke-WebRequest -Uri $perlUrl -OutFile $perlInstaller
          Start-Process msiexec.exe -Wait -ArgumentList "/i $perlInstaller /quiet /norestart"
          # Add Perl to PATH for this session
          $env:PATH = "C:\Strawberry\perl\bin;C:\Strawberry\perl\site\bin;" + $env:PATH
          perl --version

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Download and extract OpenSSL
        run: |
          $OPENSSL_VERSION = (Select-String -Path "contrib\src\openssl\rules.mak" -Pattern "OPENSSL_VERSION :=").Line.Split(' ')[2]
          Write-Host "OpenSSL version: $OPENSSL_VERSION"
          $OPENSSL_URL = "https://www.openssl.org/source/openssl-$OPENSSL_VERSION.tar.gz"
          Write-Host "Downloading OpenSSL from $OPENSSL_URL"
          
          # Create temp directory
          New-Item -ItemType Directory -Force -Path "temp" | Out-Null
          Set-Location "temp"
          
          # Download OpenSSL
          Invoke-WebRequest -Uri $OPENSSL_URL -OutFile "openssl.tar.gz"
          
          # Extract using 7zip (available on Windows runners)
          & "C:\Program Files\7-Zip\7z.exe" x openssl.tar.gz
          & "C:\Program Files\7-Zip\7z.exe" x openssl.tar
          
          # Move to expected location
          Move-Item -Path "openssl-$OPENSSL_VERSION" -Destination "..\openssl-source" -Force
          Set-Location ".."

      - name: Build OpenSSL
        shell: cmd
        env:
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          @echo off
          setlocal
          
          REM Set architecture-specific variables
          if "%BUILD_ARCH%"=="x64" (
            set OPENSSL_CONFIG=VC-WIN64A
            set OPENSSL_PREFIX=C:\OpenSSL-Win64
            set VS_ARCH=x64
          ) else (
            set OPENSSL_CONFIG=VC-WIN32
            set OPENSSL_PREFIX=C:\OpenSSL-Win32
            set VS_ARCH=x86
          )
          
          echo Building OpenSSL for %BUILD_ARCH%...
          echo Config: %OPENSSL_CONFIG%
          echo Prefix: %OPENSSL_PREFIX%
          
          cd openssl-source
          
          REM Configure OpenSSL
          perl Configure %OPENSSL_CONFIG% --prefix=%OPENSSL_PREFIX% --openssldir=%OPENSSL_PREFIX%\ssl no-shared no-unit-test
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          REM Build OpenSSL
          nmake
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          REM Install OpenSSL
          nmake install
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          cd ..
          
          echo ✅ OpenSSL build completed successfully

      - name: Download and extract curl
        run: |
          $CURL_VERSION = (Select-String -Path "contrib\src\curl\rules.mak" -Pattern "CURL_VERSION :=").Line.Split(' ')[2]
          Write-Host "curl version: $CURL_VERSION"
          $CURL_URL = "http://curl.haxx.se/download/curl-$CURL_VERSION.tar.gz"
          Write-Host "Downloading curl from $CURL_URL"
          
          # Create temp directory
          New-Item -ItemType Directory -Force -Path "temp" | Out-Null
          Set-Location "temp"
          
          # Download curl
          Invoke-WebRequest -Uri $CURL_URL -OutFile "curl.tar.gz"
          
          # Extract using 7zip
          & "C:\Program Files\7-Zip\7z.exe" x curl.tar.gz
          & "C:\Program Files\7-Zip\7z.exe" x curl.tar
          
          # Move to expected location
          Move-Item -Path "curl-$CURL_VERSION" -Destination "..\curl-source" -Force
          Set-Location ".."

      - name: Build curl with CMake
        shell: cmd
        env:
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          @echo off
          setlocal
          
          REM Set architecture-specific variables
          if "%BUILD_ARCH%"=="x64" (
            set OPENSSL_PREFIX=C:\OpenSSL-Win64
            set CURL_PREFIX=C:\curl-Win64
            set CMAKE_ARCH=x64
          ) else (
            set OPENSSL_PREFIX=C:\OpenSSL-Win32
            set CURL_PREFIX=C:\curl-Win32
            set CMAKE_ARCH=Win32
          )
          
          echo Building curl for %BUILD_ARCH%...
          echo OpenSSL prefix: %OPENSSL_PREFIX%
          echo curl prefix: %CURL_PREFIX%
          
          cd curl-source
          
          REM Create build directory
          if not exist build mkdir build
          cd build
          
          REM Configure with CMake
          cmake .. -G "Visual Studio 17 2022" -A %CMAKE_ARCH% ^
            -DCMAKE_INSTALL_PREFIX=%CURL_PREFIX% ^
            -DOPENSSL_ROOT_DIR=%OPENSSL_PREFIX% ^
            -DCURL_USE_OPENSSL=ON ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_BUILD_TYPE=Release
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          REM Build curl
          cmake --build . --config Release
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          REM Install curl
          cmake --install . --config Release
          if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
          
          cd ..\..
          
          echo ✅ curl build completed successfully

      - name: Verify build artifacts
        shell: cmd
        env:
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          @echo off
          setlocal
          
          REM Set architecture-specific variables
          if "%BUILD_ARCH%"=="x64" (
            set OPENSSL_PREFIX=C:\OpenSSL-Win64
            set CURL_PREFIX=C:\curl-Win64
          ) else (
            set OPENSSL_PREFIX=C:\OpenSSL-Win32
            set CURL_PREFIX=C:\curl-Win32
          )
          
          echo Verifying OpenSSL artifacts...
          if exist "%OPENSSL_PREFIX%\lib\libssl.lib" (
            echo ✅ Found libssl.lib
          ) else (
            echo ❌ libssl.lib not found
            exit /b 1
          )
          
          if exist "%OPENSSL_PREFIX%\lib\libcrypto.lib" (
            echo ✅ Found libcrypto.lib
          ) else (
            echo ❌ libcrypto.lib not found
            exit /b 1
          )
          
          echo Verifying curl artifacts...
          if exist "%CURL_PREFIX%\bin\libcurl.dll" (
            echo ✅ Found libcurl.dll
          ) else (
            echo ❌ libcurl.dll not found
            exit /b 1
          )
          
          if exist "%CURL_PREFIX%\lib\libcurl.lib" (
            echo ✅ Found libcurl.lib
          ) else (
            echo ⚠️ libcurl.lib not found (may be named differently)
          )
          
          echo ✅ All artifacts verified

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openssl-curl-windows-${{ matrix.arch }}
          path: |
            C:\OpenSSL-Win${{ matrix.arch == 'x64' && '64' || '32' }}\lib\
            C:\OpenSSL-Win${{ matrix.arch == 'x64' && '64' || '32' }}\include\
            C:\OpenSSL-Win${{ matrix.arch == 'x64' && '64' || '32' }}\bin\
            C:\curl-Win${{ matrix.arch == 'x64' && '64' || '32' }}\lib\
            C:\curl-Win${{ matrix.arch == 'x64' && '64' || '32' }}\include\
            C:\curl-Win${{ matrix.arch == 'x64' && '64' || '32' }}\bin\
          retention-days: 7

  test-patch-compatibility:
    name: Test Patch Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download OpenSSL source
        run: |
          OPENSSL_VERSION=$(grep "OPENSSL_VERSION :=" contrib/src/openssl/rules.mak | cut -d' ' -f3)
          # Build URL manually since rules.mak uses Makefile variable syntax $(OPENSSL_VERSION)
          OPENSSL_URL="https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz"
          echo "Downloading OpenSSL $OPENSSL_VERSION from $OPENSSL_URL"
          wget -q "$OPENSSL_URL" -O openssl.tar.gz || {
            echo "Failed to download OpenSSL. Trying alternative URL..."
            # Try alternative download location if primary fails
            wget -q "https://github.com/openssl/openssl/archive/OpenSSL_${OPENSSL_VERSION//./_}.tar.gz" -O openssl.tar.gz || exit 1
          }
          tar -xzf openssl.tar.gz
          # Handle different archive naming conventions
          if [ -d "openssl-${OPENSSL_VERSION}" ]; then
            mv openssl-${OPENSSL_VERSION} openssl-source
          elif [ -d "openssl-OpenSSL_${OPENSSL_VERSION//./_}" ]; then
            mv openssl-OpenSSL_${OPENSSL_VERSION//./_} openssl-source
          else
            mv openssl-* openssl-source 2>/dev/null || {
              echo "Could not find extracted OpenSSL directory"
              ls -la
              exit 1
            }
          fi

      - name: Test Android patch
        run: |
          echo "Testing android-clang.patch compatibility..."
          cd openssl-source
          if patch -p1 --dry-run < ../contrib/src/openssl/android-clang.patch > /dev/null 2>&1; then
            echo "✅ android-clang.patch is compatible"
          else
            echo "⚠️ android-clang.patch may have compatibility issues"
            echo "Attempting to apply patch to see detailed errors..."
            patch -p1 < ../contrib/src/openssl/android-clang.patch || true
          fi

      - name: Test iOS patch
        run: |
          echo "Testing ios-armv7-crash.patch compatibility..."
          cd openssl-source
          if patch -p1 --dry-run < ../contrib/src/openssl/ios-armv7-crash.patch > /dev/null 2>&1; then
            echo "✅ ios-armv7-crash.patch is compatible"
          else
            echo "⚠️ ios-armv7-crash.patch may have compatibility issues"
            echo "Attempting to apply patch to see detailed errors..."
            patch -p1 < ../contrib/src/openssl/ios-armv7-crash.patch || true
          fi

